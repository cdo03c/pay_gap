---
title: "Sample Pay Gap Analysis in R"
author: "Created by cdo03c  GitHub: https://github.com/cdo03c"
date: 'Produced in January 2018'
output:
  html_document:
    df_print: paged
---


The following report is a template for conducting and presenting Gender Pay-Gap Analysis in an organization, such as a company or government agency.  This report will address the following questions:
*Is there a significant difference in income between men and women in this organization? 
*Does the difference vary depending on other factors?

The sample data used to generate this report is a heavily modified combination of two sample data sets provided by Glassdoor.com and the Workplace Equality Government Agency (WEGA) of Australia for conducting gender pay gap analysis.  This data structure is highly recommended as the minimum features that should be considered in a gender pay gap analysis, but may not reflect the specific structure of various organization.  For more information about the data and its structure, please consult the ReadMe file for this project: https://github.com/cdo03c/pay_gap/blob/master/README.md.

```{r global_options, include=FALSE}
# Clear workspace
rm(list=ls())

# Load R libraries
library(plyr)
library(ggplot2)
library(knitr)
library(xlsx)
library(stargazer)
library(broom)
library(dplyr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

# Turn off scientific notation 
options(scipen=999)

#Set random seed for reproducibility
set.seed(1234)


# Download the .xslx of the sample pay roll data if it does not exist in the
# working directory
if(!file.exists("./sample_payroll_data2.csv")){
  download.file(url = "https://github.com/cdo03c/pay_gap/raw/master/sample_payroll_data2.csv",
                destfile = "./sample_payroll_data2.csv")
}

# Load data
data <- read.csv("./sample_payroll_data2.csv")
```




```{r, echo=FALSE}
#############################
# Data Cleaning and Prep.
#############################

#Convert disabilty and veteran columns from numeric to factor
data$disability = as.factor(data$disability)
data$veteran = as.factor(data$veteran)

#Convert the Date column to a date type
data$Date = as.Date(data$Date, format = )

#Remove any columns consisting only of NAs
data <- data[,colSums(is.na(data))<nrow(data)]

# Create five employee age bins.
data$age_bin <- 0
data$age_bin <- ifelse(data$age < 25, 1, data$age_bin) # Below age 25
data$age_bin <- ifelse(data$age >= 25 & data$age < 35, 2, data$age_bin) # Age 25-34.
data$age_bin <- ifelse(data$age >= 35 & data$age < 45, 3, data$age_bin) # Age 35-44.
data$age_bin <- ifelse(data$age >= 45 & data$age < 55, 4, data$age_bin) # Age 45-54.
data$age_bin <- ifelse(data$age >= 55, 5, data$age_bin) # Age 55+.

# Create total compensation variable (base pay + bonus)
data$totalPay <- data$basePay + data$bonus

# Take natural logarithm of compensation variables (for percentage pay gap interpretation in regressions).
data$log_base <- log(data$basePay, base = exp(1)) # Base pay.
data$log_total <- log(data$totalPay, base = exp(1)) # Total comp.
data$log_bonus <- log(data$bonus + 1, base = exp(1)) # Incentive pay. Add 1 to allow for log of 0 bonus values. 

# Create gender dummies (male = 1, female = 0. 
data$male <- ifelse(data$gender == "Male", 1, 0) # Male = 1, Female = 0.

```

###Gender Pay Gap

The following `r format(max(data$Date), format = '%Y')` gender pay gap report explores the base pay for our `r nrow(data)` staff may receive by gender, seeking to expose any imbalance. We will use report results to assess;

    levels of gender equality in our workplace
    balance of male and female employees at different levels
    and how effectively talent is being maximised and rewarded. 


Unlike equal pay, which refers to paying a man and a woman the same amount
for the same, or similar work, a pay gap is the difference in average pay
between men and women in an organisation. It is the result of gender or ethnic
imbalance — having more women in junior roles or fewer women in senior roles,
relative to men. This means having a pay gap is likely to persist until organisations
have fair representation of men, women and ethnic minorities at every level —
something we are passionate about addressing.  Steps will be taken, where possible, to minimise or readdress any identified inequities going forward.


```{r}
#############################
# Summary Statistics. 
#############################

# Create an overall table of summary statistics for the data.
summary(data)

# Base pay summary stats.
summary_base = tapply(data$basePay, data$gender, summary)

# Total pay summary stats.
summary_total = tapply(data$totalPay, data$gender, summary)

# Bonus summary stats.
summary_bonus = tapply(data$bonus, data$gender, summary)

# Performance evaluations summary stats. 
summary_perf = tapply(data$perfEval, data$gender, summary)

# Departmental distribution of employees.
summary_unit <- group_by(data, organisationUnit, gender)
summary_unit <- summarise(summary_unit, meanTotalPay = mean(totalPay, na.rm = TRUE), cnt = sum(!(is.na(organisationUnit))) )# %>% arrange(desc(organisationUnit, gender))

# Job title distribution of employees (Note: There is a disproportionate number of men in Manager and Software Engineer jobs).
summary_job <- group_by(data, title, gender)
summary_job <- summarise(summary_job, meanTotalPay = mean(totalPay, na.rm = TRUE), cnt = sum(!(is.na(title))) ) %>% arrange(desc(title, gender))
```
## Gender Pay Gap Summary

Based on the Government’s methodology, EY’s median gender pay gap is 14.8%
and we estimate that this figure has improved by 10% from our calculation in 2012.
EY’s median ethnicity pay gap for the UK is 9.8%.